package com.zozofood.service;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.stereotype.Service;

import com.zozofood.dao.OrderRepository;
import com.zozofood.dto.OrderRequestDto;
import com.zozofood.dto.OrderResponseDto;
import com.zozofood.entity.Order;
import com.zozofood.entity.OrderItems;

@Service
public class OrderServiceImp  implements OrderService {
	
	public static final BigDecimal TAX_RATE = BigDecimal.valueOf(0.08);
	
	private final OrderRepository orderRepository;
	
	public OrderServiceImp(OrderRepository orderRepository) {
		this.orderRepository = orderRepository;
	}

	@Override
	public OrderResponseDto createOrder(OrderRequestDto orderRequestDto) {
		
		 Order order = new Order();
	        order.setUserId(orderRequestDto.getUserId());
	        order.setStatus(Order.OrderStatus.PENDING);
	        order.setPaymentStatus(Order.PaymentStatus.PENDING);
	        order.setOrderDate(LocalDateTime.now());
	        order.setRecipientName(orderRequestDto.getRecipentname());
	        order.setContactEmail(orderRequestDto.getContactEmail());
	        order.setShippingAddress(orderRequestDto.getShippingAddress());
	        order.setContactPhone(orderRequestDto.getContactPhone());
		
	       List<OrderItems> orderItems = orderRequestDto.getOrderItems().stream().map(itemDto -> {
	            OrderItems item = new OrderItems();
	            item.setMenuItemId(itemDto.getItemId());
	            item.setQuantityOrdered(itemDto.getQuantity());
	            item.setSubtotalPrice(
	            		calculateSubtotalPrice(itemDto.getItemId(), itemDto.getQuantity()));
	            return item;
	        }).collect(Collectors.toList());
	       
	       order.setOrderItemList(orderItems);
	        BigDecimal subtotal = orderItems.stream()
	                .map(OrderItems::getSubtotalPrice)
	                .reduce(BigDecimal.ZERO, BigDecimal::add);
	        
	        BigDecimal tax = subtotal.multiply(Constants.TAX_RATE);

	        order.setTotalAmount(subtotal.add(tax));

	        Order savedOrder = orderRepository.save(order);
	        logger.info("Order created: " + savedOrder);

	        // send order notification
	        OrderResponse orderResponse = orderToOrderResponse(savedOrder);
	        sendOrderNotification(orderResponse);

		 
		return null;
	}

	private BigDecimal calculateSubtotalPrice(Long itemId, int quantity) {
		   BigDecimal price = restaurantClient.getPriceByMenuItemId(itemId);
	        return price.multiply(BigDecimal.valueOf(quantity));
	}

}
